<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>C64 PETSCII Full‐Screen Demo</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      background: #000;
      width: 100%;
      height: 100%;
    }
    canvas {
      display: block;
      image-rendering: pixelated;
    }
  </style>
</head>
<body>
  <canvas id="fontCanvas"></canvas>

  <script type="module">
    // ─────────────────────────────────────────────────────────────────────────────
    // 1) Import the full 256‐entry PETSCII font array (each entry is an 8‐byte array)
    // ─────────────────────────────────────────────────────────────────────────────
    import { font8x8_petscii } from './petscii.js';

    // ─────────────────────────────────────────────────────────────────────────────
    // 2) Set up canvas & colors
    // ─────────────────────────────────────────────────────────────────────────────
    const canvas = document.getElementById('fontCanvas');
    const ctx    = canvas.getContext('2d');
    const bgColor   = '#000';   // black
    const fontColor = '#0F0';   // bright green

    // ─────────────────────────────────────────────────────────────────────────────
    // 3) Utility to clamp a code to 0..255
    // ─────────────────────────────────────────────────────────────────────────────
    function getCode(ch) {
      if (typeof ch === 'string') {
        return ch.charCodeAt(0) & 0xFF;
      }
      return ch & 0xFF;
    }

    // ─────────────────────────────────────────────────────────────────────────────
    // 4) drawChar() – plot one 8×8 glyph at (x,y) using a given scale
    // ─────────────────────────────────────────────────────────────────────────────
    function drawChar(ctx, ch, x, y, scale = 1) {
      const code = getCode(ch);
      const glyph = font8x8_petscii[code]; // guaranteed 8‐byte array
      for (let row = 0; row < 8; row++) {
        const rowByte = glyph[row];
        for (let bit = 0; bit < 8; bit++) {
          if (rowByte & (1 << (7 - bit))) {
            ctx.fillRect(
              x + bit * scale,
              y + row * scale,
              scale, scale
            );
          }
        }
      }
    }

    // ─────────────────────────────────────────────────────────────────────────────
    // 5) redrawAll() – clear canvas, pick the largest scale so that 256 glyphs fit,
    //    then draw them in a grid.
    // ─────────────────────────────────────────────────────────────────────────────
    function redrawAll() {
      const W = window.innerWidth;
      const H = window.innerHeight;
      canvas.width  = W;
      canvas.height = H;

      // Fill background
      ctx.fillStyle = bgColor;
      ctx.fillRect(0, 0, W, H);

      // 1px between each glyph
      const letterSpacing = 1;

      // Find the largest integer “scale” where 256 glyphs (8×8 each) fit inside W×H
      let chosenScale = 1;
      for (let s = Math.floor(Math.min(W / 8, H / 8)); s >= 1; s--) {
        const cellW = 8 * s + letterSpacing;
        const maxCols = Math.floor(W / cellW);
        if (maxCols < 1) continue;
        const rowsNeeded = Math.ceil(256 / maxCols);
        const totalH = rowsNeeded * (8 * s + letterSpacing);
        if (totalH <= H) {
          chosenScale = s;
          break;
        }
      }

      ctx.fillStyle = fontColor;
      const cellW = 8 * chosenScale + letterSpacing;
      const cellH = 8 * chosenScale + letterSpacing;
      const maxCols = Math.floor(W / cellW);

      for (let code = 0; code < 256; code++) {
        const idx = code; // 0..255
        const col = idx % maxCols;
        const row = Math.floor(idx / maxCols);
        const x = col * cellW;
        const y = row * cellH;
        drawChar(ctx, code, x, y, chosenScale);
      }
    }

    // ─────────────────────────────────────────────────────────────────────────────
    // 6) Redraw on load & resize
    // ─────────────────────────────────────────────────────────────────────────────
    window.addEventListener('load', redrawAll);
    window.addEventListener('resize', () => {
      window.requestAnimationFrame(redrawAll);
    });
  </script>
</body>
</html>
